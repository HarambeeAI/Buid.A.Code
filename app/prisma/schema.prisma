// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider   = "prisma-client-js"
  engineType = "binary"
}

datasource db {
  provider = "postgresql"
}

// Enums for User
enum Tier {
  FREE
  PRO
}

enum Role {
  USER
  ADMIN
}

// Enums for Analysis - US-002
enum Region {
  AU
  UK
  US
}

enum DocumentType {
  PDF
  PNG
  JPG
  TIFF
  DXF
  IFC
}

enum AnalysisStatus {
  PENDING
  CLASSIFYING
  ANALYSING
  VALIDATING
  GENERATING
  COMPLETED
  FAILED
}

enum OverallStatus {
  PASS
  CONDITIONAL
  FAIL
}

// Enums for Finding - US-003
enum FindingCategory {
  STRUCTURAL
  FIRE_SAFETY
  EGRESS
  ACCESSIBILITY
  ENERGY
  GENERAL_BUILDING
  SITE
  PLUMBING
  ELECTRICAL
  MECHANICAL
}

enum FindingStatus {
  COMPLIANT
  WARNING
  CRITICAL
  NOT_ASSESSED
}

enum Confidence {
  HIGH
  MEDIUM
  LOW
}

// Enums for BuildingCode - US-004
enum BuildingCodeStatus {
  DRAFT
  ACTIVE
  DEPRECATED
}

// Enums for CodeRequirement - US-004
enum CodeRequirementStatus {
  DRAFT
  VERIFIED
  PUBLISHED
  DEPRECATED
}

enum CheckType {
  MEASUREMENT_THRESHOLD
  PRESENCE_CHECK
  RATIO_CHECK
  BOOLEAN_CHECK
}

// Enums for CodeRequest - US-005
enum CodeRequestStatus {
  SUBMITTED
  UNDER_REVIEW
  IN_PROGRESS
  PUBLISHED
  DECLINED
}

// User model - US-001
model User {
  id                 String    @id @default(uuid()) @db.Uuid
  logto_user_id      String    @unique
  email              String
  name               String?
  tier               Tier      @default(FREE)
  analyses_remaining Int?      @default(2)
  role               Role      @default(USER)
  created_at         DateTime  @default(now())
  updated_at         DateTime  @updatedAt

  // Relations
  projects       Project[]
  folders        Folder[]
  publishedCodes BuildingCode[]
  codeRequests   CodeRequest[]

  @@map("users")
}

// Folder model - US-001
model Folder {
  id         String   @id @default(uuid()) @db.Uuid
  user_id    String   @db.Uuid
  name       String
  created_at DateTime @default(now())

  // Relations
  user     User      @relation(fields: [user_id], references: [id], onDelete: Cascade)
  projects Project[]

  @@map("folders")
}

// Project model - US-001
model Project {
  id          String   @id @default(uuid()) @db.Uuid
  user_id     String   @db.Uuid
  name        String
  description String?
  folder_id   String?  @db.Uuid
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  // Relations
  user     User       @relation(fields: [user_id], references: [id], onDelete: Cascade)
  folder   Folder?    @relation(fields: [folder_id], references: [id], onDelete: SetNull)
  analyses Analysis[]

  @@map("projects")
}

// Analysis model - US-002
model Analysis {
  id               String         @id @default(uuid()) @db.Uuid
  project_id       String         @db.Uuid
  report_ref       String         @unique // BAC-YYYY-NNNNN format
  document_name    String
  document_url     String
  document_size    Int
  document_type    DocumentType
  page_count       Int
  description      String?
  page_numbers     String?        // Optional page range specification
  region           Region
  selected_codes   Json           // Array of selected code IDs
  status           AnalysisStatus @default(PENDING)
  current_stage    String?
  compliance_score Float?
  overall_status   OverallStatus?
  critical_count   Int            @default(0)
  warning_count    Int            @default(0)
  compliant_count  Int            @default(0)
  not_assessed_count Int          @default(0)
  total_checks     Int            @default(0)
  started_at       DateTime?
  completed_at     DateTime?
  created_at       DateTime       @default(now())

  // Relations
  project     Project      @relation(fields: [project_id], references: [id], onDelete: Cascade)
  findings    Finding[]
  shareTokens ShareToken[]

  @@map("analyses")
}

// Finding model - US-003
model Finding {
  id              String          @id @default(uuid()) @db.Uuid
  analysis_id     String          @db.Uuid
  code_reference  String
  category        FindingCategory
  status          FindingStatus
  confidence      Confidence
  description     String
  required_value  String
  proposed_value  String?
  page_number     Int?
  location        String?
  analysis_notes  String
  recommendation  String?
  raw_extraction  Json?
  sort_order      Int

  // Relations
  analysis Analysis @relation(fields: [analysis_id], references: [id], onDelete: Cascade)

  // Index for efficient querying
  @@index([analysis_id, sort_order])
  @@map("findings")
}

// BuildingCode model - US-004
model BuildingCode {
  id                  String             @id @default(uuid()) @db.Uuid
  region              Region
  code_id             String             @unique // e.g., "IRC-2021", "NCC-2022"
  name                String
  description         String?
  version             String
  status              BuildingCodeStatus @default(DRAFT)
  source_document_url String?
  published_at        DateTime?
  published_by        String?            @db.Uuid
  created_at          DateTime           @default(now())

  // Relations
  publisher              User?             @relation(fields: [published_by], references: [id], onDelete: SetNull)
  requirements           CodeRequirement[]
  resolvedCodeRequests   CodeRequest[]

  @@map("building_codes")
}

// CodeRequirement model - US-004
model CodeRequirement {
  id                       String                @id @default(uuid()) @db.Uuid
  building_code_id         String                @db.Uuid
  code_ref                 String                // e.g., "R302.1"
  title                    String
  category                 FindingCategory
  full_text                String
  check_type               CheckType
  thresholds               Json                  // JSON for threshold values
  applies_to_drawing_types Json                  // Array of page types
  applies_to_building_types Json                 // Array of building types
  applies_to_spaces        Json                  // Array of space types
  exceptions               Json                  // Array of exception conditions
  extraction_guidance      String                @db.Text
  evaluation_guidance      String                @db.Text
  source_page              Int?
  status                   CodeRequirementStatus @default(DRAFT)
  created_at               DateTime              @default(now())
  updated_at               DateTime              @updatedAt

  // Relations
  building_code BuildingCode @relation(fields: [building_code_id], references: [id], onDelete: Cascade)

  @@map("code_requirements")
}

// CodeRequest model - US-005
model CodeRequest {
  id               String            @id @default(uuid()) @db.Uuid
  user_id          String            @db.Uuid
  code_name        String
  region           Region
  description      String?
  reference_url    String?
  status           CodeRequestStatus @default(SUBMITTED)
  admin_notes      String?
  resolved_code_id String?           @db.Uuid
  created_at       DateTime          @default(now())
  updated_at       DateTime          @updatedAt

  // Relations
  user         User          @relation(fields: [user_id], references: [id], onDelete: Cascade)
  resolvedCode BuildingCode? @relation(fields: [resolved_code_id], references: [id], onDelete: SetNull)

  @@map("code_requests")
}

// ShareToken model - US-005
model ShareToken {
  id          String   @id @default(uuid()) @db.Uuid
  analysis_id String   @db.Uuid
  token       String   @unique
  is_active   Boolean  @default(true)
  created_at  DateTime @default(now())

  // Relations
  analysis Analysis @relation(fields: [analysis_id], references: [id], onDelete: Cascade)

  @@map("share_tokens")
}
