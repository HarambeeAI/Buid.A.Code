# Progress Log

## Learnings
(Patterns discovered during implementation)

- Prisma 7.x uses a new config format: datasource URL goes in prisma.config.ts, not in schema.prisma
- Use `prisma-client-js` as the generator provider (not `prisma-client`)
- Prisma validate and generate work without a running database - good for CI/CD
- Use `prisma migrate diff --from-empty --to-schema ./prisma/schema.prisma --script` to preview migration SQL

---

## Iteration 1 - US-001: Core Schema - User, Project, Folder
- What was implemented:
  - Next.js 14+ project with TypeScript and Tailwind CSS
  - Prisma schema with User, Project, Folder models
  - User model: UUID id, logto_user_id (unique), email, name, tier (FREE/PRO default FREE), analyses_remaining (default 2, nullable), role (USER/ADMIN default USER), timestamps
  - Folder model: user_id FK with cascade delete
  - Project model: user_id FK with cascade delete, folder_id FK with SET NULL on delete
  - Migration SQL file ready for Railway PostgreSQL
  - Prisma client helper in src/lib/prisma.ts
- Files changed:
  - app/prisma/schema.prisma (new)
  - app/prisma/migrations/0001_init/migration.sql (new)
  - app/src/lib/prisma.ts (new)
  - app/prisma.config.ts (modified for Prisma 7)
  - app/.env.example (new)
- Learnings for future iterations:
  - Project is inside /app subdirectory due to npm naming restrictions
  - TypeScript check: `npx tsc --noEmit`
  - Prisma validation: `npx prisma validate`
  - Migration preview: `npx prisma migrate diff --from-empty --to-schema ./prisma/schema.prisma --script`
---

## Iteration 2 - US-002: Schema - Analysis
- What was implemented:
  - Added Analysis model to Prisma schema with all required fields
  - Added enums: Region (AU/UK/US), DocumentType (PDF/PNG/JPG/TIFF/DXF/IFC), AnalysisStatus (7 states), OverallStatus (PASS/CONDITIONAL/FAIL)
  - Analysis fields: id (UUID), project_id (FK), report_ref (unique), document_name, document_url, document_size, document_type, page_count, description (nullable), page_numbers (nullable), region, selected_codes (JSON), status, current_stage (nullable), compliance_score (nullable), overall_status (nullable), count fields (all default 0), timestamps
  - Cascade delete: Project -> Analyses
  - Created migration SQL file
- Files changed:
  - app/prisma/schema.prisma (modified - added enums and Analysis model)
  - app/prisma/migrations/0002_analysis/migration.sql (new)
- Learnings for future iterations:
  - Each migration folder needs its own migration.sql file
  - Prisma generate must be run after schema changes to update the client
  - The analyses relation was added to the Project model for cascade functionality
---

## Iteration 3 - US-003: Schema - Finding
- What was implemented:
  - Added Finding model to Prisma schema with all required fields
  - Added enums: FindingCategory (10 values: STRUCTURAL, FIRE_SAFETY, EGRESS, ACCESSIBILITY, ENERGY, GENERAL_BUILDING, SITE, PLUMBING, ELECTRICAL, MECHANICAL), FindingStatus (4 values: COMPLIANT, WARNING, CRITICAL, NOT_ASSESSED), Confidence (HIGH, MEDIUM, LOW)
  - Finding fields: id (UUID), analysis_id (FK), code_reference, category, status, confidence, description, required_value, proposed_value (nullable), page_number (nullable), location (nullable), analysis_notes, recommendation (nullable), raw_extraction (JSON nullable), sort_order
  - Cascade delete: Analysis -> Findings
  - Composite index on (analysis_id, sort_order) for efficient querying
  - Created migration SQL file
- Files changed:
  - app/prisma/schema.prisma (modified - added enums and Finding model, added findings relation to Analysis)
  - app/prisma/migrations/0003_finding/migration.sql (new)
- Learnings for future iterations:
  - When adding a new model with a relation, update both sides (Finding model + findings[] on Analysis)
  - Composite indexes use @@index([field1, field2]) syntax in Prisma
---

## Iteration 4 - US-004: Schema - BuildingCode and CodeRequirement
- What was implemented:
  - Added BuildingCode model with all required fields: id (UUID), region (FK to Region enum), code_id (unique), name, description (nullable), version, status (BuildingCodeStatus enum: DRAFT/ACTIVE/DEPRECATED), source_document_url (nullable), published_at (nullable), published_by (nullable FK to User), created_at
  - Added CodeRequirement model with complete schema: id (UUID), building_code_id (FK), code_ref, title, category (FindingCategory enum), full_text, check_type (CheckType enum), thresholds (JSON), applies_to_drawing_types (JSON), applies_to_building_types (JSON), applies_to_spaces (JSON), exceptions (JSON), extraction_guidance (Text), evaluation_guidance (Text), source_page (nullable), status (CodeRequirementStatus enum: DRAFT/VERIFIED/PUBLISHED/DEPRECATED), embedding (vector 768 via pgvector), timestamps
  - Added enums: BuildingCodeStatus, CodeRequirementStatus, CheckType
  - Enabled pgvector extension for embedding support
  - Cascade delete: BuildingCode -> CodeRequirements
  - Added publishedCodes relation on User model for published_by FK
- Files changed:
  - app/prisma/schema.prisma (modified - added enums, BuildingCode, CodeRequirement models)
  - app/prisma/migrations/0004_building_code_and_requirement/migration.sql (new)
- Learnings for future iterations:
  - pgvector requires `CREATE EXTENSION IF NOT EXISTS vector;` in migration SQL
  - Use `Unsupported("vector(768)")` in Prisma schema for pgvector types
  - When adding a FK relation like published_by, add the reverse relation on the parent model (User.publishedCodes)
---
